// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated"
  binaryTargets = ["native", "windows", "darwin"]
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                  String              @id @default(cuid())
  nom                 String
  prenom              String
  email               String              @unique
  telephone           String
  mot_de_passe        String
  role                Role
  avatar              String?             @db.VarChar(255)
  adresse             String?             @db.Text
  localisation        String?             @db.VarChar(100)
  latitude            Float?
  longitude           Float?
  statut              Statut              @default(actif)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  produits            Produit[]
  commandesFournies   CommandeProduit[]
  commandesCollecteur Commande[]
  notifications       UserNotification[]

  messagesEnvoyes     Message[]          @relation("Expediteur")
  messagesRecus       Message[]          @relation("Destinataire")
  conversationsP1     Conversation[]     @relation("Participant1")
  conversationsP2     Conversation[]     @relation("Participant2")

  @@index([role])
  @@index([localisation])
}

enum Statut {
  actif
  inactif
  suspendu
}

enum Role {
  paysan
  collecteur
  admin
}

model Produit {
  id                 String             @id @default(cuid())
  nom                String             @db.VarChar(150)
  type               ProduitType
  sousType           String?            @db.VarChar(100)
  description        String?            @db.Text
  quantiteDisponible Decimal            @db.Decimal(10, 2)
  unite              Unite              @default(kg)
  prixUnitaire       Decimal            @db.Decimal(10, 2)
  dateRecolte        DateTime
  datePeremption     DateTime?
  imageUrl           String?            @db.VarChar(255)
  statut             ProduitStatut      @default(disponible)
  conditionsStockage String?            @db.Text
  localisation       String?            @db.VarChar(100)
  latitude           Float?
  longitude          Float?

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  paysanId           String
  paysan             User              @relation(fields: [paysanId], references: [id], onDelete: Cascade)

  commandesProduit   CommandeProduit[]

  @@index([paysanId])
  @@index([type])
  @@index([statut])
  @@index([dateRecolte])
}

// Enum pour le type de produit
enum ProduitType {
  grain
  legumineuse
  tubercule
  fruit
  legume
  epice
  autre
}

// Enum pour lâ€™unitÃ©
enum Unite {
  kg
  tonne
  sac
  litre
}

// Enum pour le statut
enum ProduitStatut {
  disponible
  indisponible
  rupture
  archive
}



model Commande {
  id                  String             @id @default(cuid())
  produitRecherche    String?
  quantiteTotal       Decimal?           @db.Decimal(10,2)
  unite               Unite              @default(kg)
  prixUnitaire        Decimal?           @db.Decimal(10,2)
  statut              CommandeStatut     @default(ouverte)
  messageCollecteur   String?            @db.Text

  adresseLivraison    String?            @db.Text
  dateLivraisonPrevue DateTime?
  dateLivraison       DateTime?

  territoire          String?
  latitude            Float?
  longitude           Float?
  rayon               Float?

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  collecteurId        String
  collecteur          User              @relation(fields: [collecteurId], references: [id])

  lignes              CommandeProduit[]

  @@index([collecteurId])
  @@index([statut])
}



// ENUMs
enum CommandeStatut {
  en_attente
  ouverte
  partiellement_fournie
  complete
  acceptee
  payee
  livree
  annulee
}



model CommandeProduit {
  id               String       @id @default(cuid())
  quantiteAccordee Decimal      @db.Decimal(10,2)
  prixUnitaire     Decimal?     @db.Decimal(10,2)
  statutLigne      StatutLigne  @default(en_attente)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  commandeId       String
  commande         Commande    @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  produitId        String
  produit          Produit     @relation(fields: [produitId], references: [id])
  paysanId         String
  paysan           User        @relation(fields: [paysanId], references: [id])

  @@index([produitId])
  @@index([paysanId])
}

// ENUM
enum StatutLigne {
  en_attente
  acceptee
  partiellement_acceptee
  livree
  rejetÃ©e
}


model Notification {
  id                   String              @id @default(cuid())
  type                 NotificationType
  titre                String
  message              String
  lien                 String?
  reference_id         String?
  reference_type       String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  allUserNotifications UserNotification[]

  @@index([type])
}

enum NotificationType {
  commande
  paiement
  message
  systeme
  alerte
}


model UserNotification {
  id             String        @id @default(cuid())
  userId         String
  notificationId String
  lu             Boolean       @default(false)
  dateLecture    DateTime?

  //             Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
}


model Conversation {
  id                   String     @id @default(cuid())
  participant1Id       String
  participant2Id       String
  dernierMessageId     String?    @unique

  messagesNonLusP1     Int        @default(0)
  messagesNonLusP2     Int        @default(0)
  dateDerniereActivite DateTime   @default(now())
  archiveP1            Boolean    @default(false)
  archiveP2            Boolean    @default(false)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  participant1         User      @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2         User      @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)

  // ðŸ‘‡ nommer la relation pour le dernier message
  dernierMessage       Message?  @relation("DernierMessage", fields: [dernierMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ðŸ‘‡ nommer la relation pour tous les messages
  messages             Message[] @relation("MessagesConversation")

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id, participant2Id])
}



model Message {
  id             String         @id @default(cuid())
  expediteurId   String
  destinataireId String
  contenu        String?
  typeContenu    MessageType    @default(texte)
  fichierUrl     String?
  lu             Boolean        @default(false)
  dateEnvoi      DateTime       @default(now())
  dateLecture    DateTime?
  updatedAt      DateTime       @updatedAt

  expediteur     User          @relation("Expediteur", fields: [expediteurId], references: [id], onDelete: Cascade)
  destinataire   User          @relation("Destinataire", fields: [destinataireId], references: [id], onDelete: Cascade)

  conversationId String?
  conversation   Conversation? @relation("MessagesConversation", fields: [conversationId], references: [id], onDelete: Cascade)

  dernierDe      Conversation? @relation("DernierMessage") 
  // inverse de dernierMessage

  @@index([expediteurId, destinataireId])
  @@index([dateEnvoi])
  @@index([lu])
}

enum MessageType {
  texte
  image
  video
  document
}
